from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.shortcuts import get_object_or_404
from django.db import transaction
from django.utils import timezone
from django.utils.text import slugify
from django.core.files.base import ContentFile
from io import BytesIO
import segno

from .models import Memorial, FamilyInvite
from .serializers import MemorialCreateSerializer, FamilyInviteCreateSerializer, MemorialPublicSerializer
from .utils import generate_short_code
from everest.permissions import IsPartnerUser, HasFamilyToken, get_partner_user

class MemorialCreate(APIView):
    permission_classes = [IsPartnerUser]
    def post(self, request):
        serializer = MemorialCreateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        data = serializer.validated_data
        short_code = generate_short_code()
        slug = slugify(f"{data.get('first_name','')}-{data.get('last_name','')}-{short_code}")[:64]
        partner_user = get_partner_user(request)
        memorial = Memorial.objects.create(
            partner=partner_user.partner if partner_user else None,
            first_name=data['first_name'],
            last_name=data['last_name'],
            birth_date=data.get('birth_date'),
            death_date=data.get('death_date'),
            quote=data.get('quote',''),
            biography_language=data.get('biography_language','en'),
            family_contact_email=data['family_contact_email'],
            theme_key=data.get('theme_key','calm'),
            short_code=short_code,
            slug=slug,
        )
        return Response({'id': memorial.id, 'short_code': memorial.short_code, 'slug': memorial.slug, 'status': memorial.status}, status=status.HTTP_201_CREATED)

class MemorialActivate(APIView):
    permission_classes = [IsPartnerUser]
    def post(self, request, memorial_id):
        memorial = get_object_or_404(Memorial, pk=memorial_id)
        url = f"http://127.0.0.1:8000/memorials/{memorial.short_code}/public/"
        qr = segno.make(url, error='h')
        png_buf = BytesIO()
        pdf_buf = BytesIO()
        qr.save(png_buf, kind='png', scale=12, border=2)
        qr.save(pdf_buf, kind='pdf', border=2)
        memorial.qr_png.save(f"{memorial.short_code}.png", ContentFile(png_buf.getvalue()), save=False)
        memorial.qr_pdf.save(f"{memorial.short_code}.pdf", ContentFile(pdf_buf.getvalue()), save=False)
        memorial.status = 'active'
        memorial.save()
        return Response({'status': memorial.status, 'qr_png': memorial.qr_png.url if memorial.qr_png else None, 'qr_pdf': memorial.qr_pdf.url if memorial.qr_pdf else None})

class FamilyInviteCreate(APIView):
    permission_classes = [IsPartnerUser]
    def post(self, request, memorial_id):
        memorial = get_object_or_404(Memorial, pk=memorial_id)
        serializer = FamilyInviteCreateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        token = generate_short_code(32)
        invite = FamilyInvite.objects.create(
            memorial=memorial,
            email=serializer.validated_data['email'],
            token=token,
            expires_at=serializer.validated_data['expires_at'],
        )
        return Response({'token': invite.token, 'expires_at': invite.expires_at.isoformat()}, status=status.HTTP_201_CREATED)

class MemorialPublic(APIView):
    authentication_classes = []
    permission_classes = []
    def get(self, request, code):
        memorial = get_object_or_404(Memorial, short_code=code, status='active')
        data = MemorialPublicSerializer(memorial).data
        return Response(data)
