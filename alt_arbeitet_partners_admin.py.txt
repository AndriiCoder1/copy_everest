from django.contrib import admin
from django import forms
from django.contrib.auth.hashers import make_password
from .models import Partner, PartnerUser

# Добавляем форму для PartnerUser
class PartnerUserForm(forms.ModelForm):
    raw_password = forms.CharField(
        widget=forms.PasswordInput,
        label="Пароль",
        required=False,
        help_text="Введите пароль для сотрудника бюро"
    )
    
    class Meta:
        model = PartnerUser
        fields = ['partner', 'email', 'raw_password', 'role']
    
    def save(self, commit=True):
        partner_user = super().save(commit=False)
        
        raw_password = self.cleaned_data.get('raw_password')
        if raw_password:
            partner_user.password_hash = make_password(raw_password)
        
        if commit:
            partner_user.save()
        return partner_user

@admin.register(Partner)
class PartnerAdmin(admin.ModelAdmin):
    list_display = ('id', 'name', 'billing_email', 'created_at')
    
    # 1. Фильтрация списка партнеров
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        if request.user.is_superuser:
            return qs
        
        # Ищем PartnerUser по email пользователя
        try:
            partner_user = PartnerUser.objects.get(email=request.user.email)
            return qs.filter(id=partner_user.partner.id)
        except PartnerUser.DoesNotExist:
            return qs.none()
    
    # 2. Ограничение создания новых партнеров
    def has_add_permission(self, request):
        return request.user.is_superuser
    
    # 3. Ограничение изменения чужих партнеров
    def has_change_permission(self, request, obj=None):
        if request.user.is_superuser:
            return True
        
        if obj is None:
            return True
        
        try:
            partner_user = PartnerUser.objects.get(email=request.user.email)
            return obj.id == partner_user.partner.id
        except PartnerUser.DoesNotExist:
            return False

@admin.register(PartnerUser)
class PartnerUserAdmin(admin.ModelAdmin):
    form = PartnerUserForm
    list_display = ('id', 'partner', 'email', 'role', 'created_at')
    
    # 1. Фильтрация списка сотрудников
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        if request.user.is_superuser:
            return qs
        
        # Ищем текущего пользователя среди PartnerUser
        try:
            current_pu = PartnerUser.objects.get(email=request.user.email)
            return qs.filter(partner=current_pu.partner)
        except PartnerUser.DoesNotExist:
            return qs.none()
    
    # 2. Фильтрация выпадающего списка партнеров
    def get_form(self, request, obj=None, **kwargs):
        form = super().get_form(request, obj, **kwargs)
        
        if not request.user.is_superuser:
            if 'partner' in form.base_fields:
                try:
                    current_pu = PartnerUser.objects.get(email=request.user.email)
                    # Показываем только своего партнера
                    form.base_fields['partner'].queryset = form.base_fields['partner'].queryset.filter(
                        id=current_pu.partner.id
                    )
                    # Автоматически назначаем своего партнера при создании
                    if not obj:  # если создаем нового пользователя
                        form.base_fields['partner'].initial = current_pu.partner
                        form.base_fields['partner'].disabled = True
                except PartnerUser.DoesNotExist:
                    form.base_fields['partner'].queryset = form.base_fields['partner'].queryset.none()
        
        return form
    
    # 3. Ограничение создания сотрудников
    def has_add_permission(self, request):
        if request.user.is_superuser:
            return True
        
        # Проверяем, есть ли PartnerUser с таким email
        try:
            PartnerUser.objects.get(email=request.user.email)
            return True
        except PartnerUser.DoesNotExist:
            return False
    
    # 4. Ограничение изменения чужих сотрудников
    def has_change_permission(self, request, obj=None):
        if request.user.is_superuser:
            return True
        
        if obj is None:
            return True
        
        try:
            current_pu = PartnerUser.objects.get(email=request.user.email)
            return obj.partner == current_pu.partner
        except PartnerUser.DoesNotExist:
            return False