from django.contrib import admin
from django import forms
from django.contrib.auth.hashers import make_password
from .models import Partner, PartnerUser

# Добавляем форму для PartnerUser
class PartnerUserForm(forms.ModelForm):
    # Добавляем поле для ввода пароля
    raw_password = forms.CharField(
        widget=forms.PasswordInput,
        label="Пароль",
        required=False,
        help_text="Введите пароль для сотрудника бюро"
    )
    
    class Meta:
        model = PartnerUser
        fields = ['partner', 'email', 'raw_password', 'role']
    
    def save(self, commit=True):
        # Получаем объект PartnerUser
        partner_user = super().save(commit=False)
        
        # Если указан пароль - создаем хеш
        raw_password = self.cleaned_data.get('raw_password')
        if raw_password:
            partner_user.password_hash = make_password(raw_password)
        
        if commit:
            partner_user.save()
        return partner_user

@admin.register(Partner)
class PartnerAdmin(admin.ModelAdmin):
    list_display = ('id', 'name', 'billing_email', 'created_at')

@admin.register(PartnerUser)
class PartnerUserAdmin(admin.ModelAdmin):
    # Используем нашу форму
    form = PartnerUserForm
    list_display = ('id', 'partner', 'email', 'role', 'created_at')